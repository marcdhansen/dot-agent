#!/bin/bash

# Universal Agent Session Gate
# This script MUST run before any agent gets control
# External enforcement that agents cannot bypass

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get session information
AGENT_PROVIDER="${AGENT_PROVIDER:-unknown}"
SESSION_ID="$(uuidgen 2>/dev/null || date +%s)-$$"
TIMESTAMP="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
WORKSPACE="$(pwd)"

# Create audit log directory
AUDIT_DIR="$HOME/.agent/logs"
mkdir -p "$AUDIT_DIR"
AUDIT_LOG="$AUDIT_DIR/session_audit.log"

# Function to log session events
log_event() {
    local event="$1"
    local details="$2"
    echo "$TIMESTAMP | $event | $AGENT_PROVIDER | $WORKSPACE | $SESSION_ID | $details" >> "$AUDIT_LOG"
}

# Function to cleanup on exit
cleanup() {
    local exit_code=$?
    if [ $exit_code -eq 0 ]; then
        log_event "SESSION_END" "status=success"
        echo -e "${GREEN}‚úÖ Session completed successfully${NC}"
    else
        log_event "SESSION_END" "status=failed exit_code=$exit_code"
        echo -e "${RED}‚ùå Session failed with exit code $exit_code${NC}"
    fi
    unset AGENT_SESSION_VALIDATED
}

# Set cleanup trap
trap cleanup EXIT

echo -e "${BLUE}üöÄ Universal Agent Session Gate${NC}"
echo -e "${BLUE}=====================================${NC}"
echo

# Log session start
log_event "SESSION_START" "provider=$AGENT_PROVIDER"

echo -e "${YELLOW}üîç Validating session prerequisites...${NC}"

# 1. Validate session prerequisites with Orchestrator
echo -e "${YELLOW}‚îú‚îÄ‚îÄ Running Orchestrator initialization check...${NC}"
if ! python3 "$HOME/.gemini/antigravity/skills/Orchestrator/scripts/check_protocol_compliance.py" --init --turbo; then
    echo -e "${RED}‚ùå BLOCKED: Orchestrator validation failed${NC}"
    echo -e "${RED}   Agent session cannot start without SOP compliance${NC}"
    log_event "VALIDATION_FAILED" "orchestrator_init_failed"
    exit 1
fi

echo -e "${GREEN}‚îú‚îÄ‚îÄ ‚úÖ Orchestrator validation passed${NC}"

# 2. Check workspace requirements
echo -e "${YELLOW}‚îú‚îÄ‚îÄ Checking workspace requirements...${NC}"

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo -e "${YELLOW}‚ö†Ô∏è  WARNING: Not in a git repository${NC}"
    log_event "WORKSPACE_WARNING" "not_git_repo"
else
    echo -e "${GREEN}‚îú‚îÄ‚îÄ ‚úÖ Git repository detected${NC}"
fi

# Check for required documentation
if [ ! -f ".agent/AGENTS.md" ] && [ ! -f "$HOME/.agent/AGENTS.md" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  WARNING: No AGENTS.md found${NC}"
    log_event "WORKSPACE_WARNING" "no_agents_md"
fi

# 3. Set environment flag that pre-commit hooks will check
export AGENT_SESSION_VALIDATED=true
export AGENT_SESSION_ID="$SESSION_ID"
export AGENT_PROVIDER="$AGENT_PROVIDER"

echo -e "${GREEN}‚îú‚îÄ‚îÄ ‚úÖ Environment configured${NC}"

# 4. Log successful session start
log_event "SESSION_INITIALIZED" "status=ready"

echo
echo -e "${GREEN}‚úÖ Session validation complete${NC}"
echo -e "${GREEN}üöÄ Agent session cleared for execution${NC}"
echo

# Display session info
echo -e "${BLUE}Session Information:${NC}"
echo -e "  Provider: ${AGENT_PROVIDER}"
echo -e "  Session ID: ${SESSION_ID}"
echo -e "  Workspace: ${WORKSPACE}"
echo -e "  Audit Log: ${AUDIT_LOG}"
echo

# Export session info for agents
export AGENT_SESSION_INFO="provider=$AGENT_PROVIDER|session_id=$SESSION_ID|workspace=$WORKSPACE"

echo -e "${YELLOW}üîë Session keys exported to environment${NC}"
echo -e "${YELLOW}üìã All activity will be logged to audit trail${NC}"
echo

# The agent can now start with full compliance validation complete